batchJobs:
  enabled: true

  # _base: &jobBase : ê³µí†µ ê¸°ë³¸(ì•µì»¤)
  # &jobBaseëŠ” ì•µì»¤(ì €ì¥ì†Œ) ì´ë¦„ì´ê³ , _base í‚¤ ì•„ë˜ì˜ ê³µí†µ ì„¤ì • ë¸”ë¡ì„ ì €ì¥.
  # ë‚˜ì¤‘ì— *jobBaseë¡œ ë¶ˆëŸ¬ì™€ì„œ ì¬ì‚¬ìš©

  _base: &jobBase
    mode: cron
    image: { repository: neo-batch-job, tag: "0.0.1", pullPolicy: IfNotPresent }
    command: ["java","-jar","/app/app.jar"]
    args:
      - "--spring.profiles.active=dev"
    resources:
      requests: { cpu: "250m", memory: "256Mi" }
      limits:   { cpu: "500m", memory: "512Mi" }
    job:
      parallelism: 1
      completions: 1
      backoffLimit: 1
      activeDeadlineSeconds: 600
      ttlSecondsAfterFinished: 7200
    cron:
      # jobë³„ë¡œ ë¶„ë§Œ ë‹¤ë¥´ê²Œ í•˜ì—¬ 5ë¶„ ì£¼ê¸° ë¶„ì‚°
      timeZone: "Asia/Seoul"
      concurrencyPolicy: "Forbid"
      startingDeadlineSeconds: 120
      successHistory: 2
      failedHistory: 1
    service: { enabled: false }

    # íŒŒì¼(B): ê³µí†µ application.yaml ì‚¬ìš©(í•„ìš”ì‹œ jobë³„ë¡œ êµì²´ ê°€ëŠ¥)
    configMap:
      enabled: true
      files: ["application.yaml"]

    # ENV(A): datasource/influxëŠ” jobë³„ë¡œ ì¡°ê¸ˆì”© ë‹¤ë¥´ê²Œ
    datasource:
      driver_class_name: com.mysql.cj.jdbc.Driver
      url: jdbc:mysql://job-ds.default.svc.cluster.local:3306/jobdb
      username: user
      password: root
    datasource_sub:
      enabled: false
    influx:
      url: http://influxdb:8086
      logLevel: BODY
      readTimeout: 5s
      writeTimeout: 5s
      connectTimeout: 5s

  jobs:
    - <<: *jobBase # ì•µì»¤ ë¶ˆëŸ¬ì˜¤ê¸° YAML ë³‘í•© í‚¤(merge key) *jobBase(ì—ì¼ë¦¬ì–´ìŠ¤)ë¡œ ê°€ë¦¬í‚¨ ê³µí†µ ë¸”ë¡ì„ ì´ í•­ëª©ì— í•©ì³ ë„£ì–´ë¼ëŠ” ëœ» 
      name: batch-job-01
      cron: { schedule: "0/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }
      configMap: { enabled: true, name: batch-job-01-config, files: ["application.yaml"] }
      args: ["--spring.profiles.active=dev","--rtm.batch.job.chunk=200"]

    - <<: *jobBase
      name: batch-job-02
      cron: { schedule: "1/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }
      configMap: { enabled: true, name: batch-job-02-config, files: ["application.yaml"] }

    - <<: *jobBase
      name: batch-job-03
      cron: { schedule: "2/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }
      datasource:
        driver_class_name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://job03-ds.default.svc.cluster.local:3306/jobdb
        username: user
        password: root

    - <<: *jobBase
      name: batch-job-04
      cron: { schedule: "3/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }

    - <<: *jobBase
      name: batch-job-05
      cron: { schedule: "4/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }

    - <<: *jobBase
      name: batch-job-06
      cron: { schedule: "0/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }
      datasource_sub:
        enabled: true
        driver_class_name: com.mysql.cj.jdbc.Driver
        url: jdbc:mysql://job06-ds-sub.default.svc.cluster.local:3306/jobdb
        username: user
        password: root

    - <<: *jobBase
      name: batch-job-07
      cron: { schedule: "1/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }

    - <<: *jobBase
      name: batch-job-08
      cron: { schedule: "2/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }

    - <<: *jobBase
      name: batch-job-09
      cron: { schedule: "3/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }

    - <<: *jobBase
      name: batch-job-10
      cron: { schedule: "4/5 * * * *", timeZone: "Asia/Seoul", concurrencyPolicy: "Forbid", startingDeadlineSeconds: 120, successHistory: 2, failedHistory: 1 }



 
# ğŸ§¾ ì¶”ê°€ ê³ ë ¤ ì‚¬í•­ ë°˜ì˜: ì‹¤ë¬´í˜• Helm ë°°í¬ ì„¤ê³„ ê¸°ë°˜ values.yaml
# Kind ê¸°ë°˜ ë¡œì»¬ í…ŒìŠ¤íŠ¸ì™€ ì‹¤ìš´ì˜ Kubernetes ë°°í¬ ê°€ëŠ¥ ì„¤ê³„

# âœ… ì „ì²´ ì•„í‚¤í…ì²˜ ê°œìš”:
# - ë°°ì¹˜ êµ¬ì„±: Spring Batch Job (10ê°œ) + SCDF Task ê¸°ë°˜ Spring Batch (10ê°œ)
# - ëª©ì : ì™¸ë¶€ DB â†’ ë°ì´í„° ì¶”ì¶œ â†’ ë³€í™˜ â†’ InfluxDB ì €ì¥ â†’ Grafana/Prometheus ì‹œê°í™”
# - Helm ê¸°ë°˜ìœ¼ë¡œ ë°°í¬, Kindì—ì„œ í…ŒìŠ¤íŠ¸ í›„ K8s ìš´ì˜ ë°˜ì˜

# mysql:
#   enabled: true
#   image:
#     repository: mysql
#     tag: "8.0"
#   auth:
#     rootPassword: root
#     database: demo
#     username: neodain
#     password: Kht72@eye1
#   service:
#     port: 3306
#     nodePort: 3307
#   persistence:
#     enabled: true
#     mountPath: /var/lib/mysql
#     existingClaim: mysql-pvc
#   nodeSelector:
#     role: work

# mariadb:
#   enabled: true
#   image:
#     repository: mariadb
#     tag: "10"
#   auth:
#     rootPassword: root
#     database: demo
#     username: neodain
#     password: Kht72@eye1
#   service:
#     port: 3306
#     nodePort: 3308
#   persistence:
#     enabled: true
#     mountPath: /var/lib/mysql
#     existingClaim: mariadb-pvc
#   nodeSelector:
#     role: work

# influxdb:
#   enabled: true
#   image:
#     repository: influxdb
#     tag: latest
#   env:
#     - name: DOCKER_INFLUXDB_INIT_MODE
#       value: setup
#     - name: DOCKER_INFLUXDB_INIT_USERNAME
#       value: neodain
#     - name: DOCKER_INFLUXDB_INIT_PASSWORD
#       value: Kht72@eye1
#     - name: DOCKER_INFLUXDB_INIT_ORG
#       value: neodain
#     - name: DOCKER_INFLUXDB_INIT_BUCKET
#       value: neodain
#     - name: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
#       value: xxxxxxxxxxxx 
#   service:
#     port: 8086
#     nodePort: 8087
#   persistence:
#     enabled: true
#     mountPath: /var/lib/influxdb2
#     existingClaim: influxdb-pvc
#   nodeSelector:
#     role: main

# grafana:
#   enabled: true
#   image:
#     repository: grafana/grafana
#     tag: latest
#   service:
#     port: 3000
#     nodePort: 3001
#   persistence:
#     enabled: true
#     mountPath: /var/lib/grafana
#     existingClaim: grafana-pvc
#   dependsOn:
#     - influxdb
#   nodeSelector:
#     role: main

# # ğŸ¯ ì‹¤ë¬´í˜• ë°°ì¹˜ ì•± (Job + Task êµ¬ë¶„ ì—†ì´ í™•ì¥ ê°€ëŠ¥)
# batchApps:
#   enabled: true
#   apps:
#     - name: batch-job-01
#       image: neodain/batch-job-01:latest
#       command:
#         - "--rtm.batch.job.start=202507091730"
#         - "--rtm.batch.job.end=202507091740"
#         - "--rtm.batch.job.chunk=200"
#         - "--rtm.batch.job.interval=10"
#         - "--rtm.batch.job.delay=5"
#       service:
#         port: 8080
#       nodeSelector:
#         role: work
#     - name: batch-task-01
#       image: neodain/batch-task-01:latest
#       command:
#         - "--spring.cloud.task.name=task01"
#       service:
#         port: 8080
#       nodeSelector:
#         role: work
#     # ... ë‚˜ë¨¸ì§€ ì•±ë„ ë™ì¼í•˜ê²Œ í™•ì¥ ê°€ëŠ¥

# # âœ¨ SCDF ê´€ë ¨ ì„¤ì • (ì¶”í›„ scdf section ì¶”ê°€ ì˜ˆì •)
# scdf:
#   enabled: true
#   nodeSelector:
#     role: main
#   externalDatabase:
#     host: mariadb
#     port: 3306
#     user: neodain
#     password: Kht72@eye1
#     database: demo
#   skipper:
#     enabled: true
