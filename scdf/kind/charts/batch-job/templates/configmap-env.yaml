{{- /* charts/batch-job/templates/configmap-env.yaml */ -}}
{{- $root := . -}}
{{- range .Values.batchJobs.jobs }}
{{- $res := include "batch-job.resname" (dict "root" $root "name" .name) -}}
{{- $hasDS  := hasKey . "datasource" -}}
{{- $hasDSS := and (hasKey . "datasource_sub") .datasource_sub -}}
{{- $hasIFX := hasKey . "influx" -}}
{{- if or $hasDS $hasDSS $hasIFX }}
{{/* 
    NOTE: 이 ConfigMap은 envFrom(환경변수)로만 주입. 파일 마운트는 configmap-file.yaml에서 생성되는 "*-config"를 사용.
    이름 규칙: "<fullname-of-app>-env"
*/}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $res }}-env
  labels:
    {{- include "batch-job.labels" $root | nindent 4 }}
data:
  {{- if $hasDS }}
  SPRING_DATASOURCE_DRIVER_CLASS_NAME: "{{ .datasource.driver_class_name }}"
  SPRING_DATASOURCE_URL: "{{ .datasource.url }}"
  SPRING_DATASOURCE_USERNAME: "{{ .datasource.username }}"
  SPRING_DATASOURCE_PASSWORD: "{{ .datasource.password }}"
  {{- end }}
  {{- if and $hasDSS .datasource_sub.enabled }}
  SPRING_DATASOURCE_SUB_DRIVER_CLASS_NAME: "{{ .datasource_sub.driver_class_name }}"
  SPRING_DATASOURCE_SUB_URL: "{{ .datasource_sub.url }}"
  SPRING_DATASOURCE_SUB_USERNAME: "{{ .datasource_sub.username }}"
  SPRING_DATASOURCE_SUB_PASSWORD: "{{ .datasource_sub.password }}"
  {{- end }}
  {{- if $hasIFX }}
  INFLUX_TOKEN: "{{ .influx.token }}"
  INFLUX_URL: "{{ .influx.url }}"
  INFLUX_LOG_LEVEL: "{{ .influx.logLevel }}"
  INFLUX_READ_TIMEOUT: "{{ .influx.readTimeout }}"
  INFLUX_WRITE_TIMEOUT: "{{ .influx.writeTimeout }}"
  INFLUX_CONNECT_TIMEOUT: "{{ .influx.connectTimeout }}"
  {{- end }}
---
{{- end }}
{{- end }}