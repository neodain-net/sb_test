# Kind ê¸°ë°˜ ë¡œì»¬ í…ŒìŠ¤íŠ¸ì™€ ì‹¤ìš´ì˜ Kubernetes ë°°í¬ ê°€ëŠ¥ ì„¤ê³„

# - ë°°ì¹˜ êµ¬ì„±: Spring Batch Job (2ê°œ) + SCDF Task ê¸°ë°˜ Spring Batch (1ê°œ)
# - ëª©ì : ì™¸ë¶€ DB â†’ ë°ì´í„° ì¶”ì¶œ â†’ ë³€í™˜ â†’ InfluxDB ì €ì¥ â†’ Grafana/Prometheus ì‹œê°í™”
# - Helm ê¸°ë°˜ìœ¼ë¡œ ë°°í¬, Kindì—ì„œ í…ŒìŠ¤íŠ¸ í›„ K8s ìš´ì˜ ë°˜ì˜
#
# - kubectl apply -f test-job.yaml
# - kubectl get pods -o wide
# - kubectl logs job/test-job
# - Kubectl get nodes : ë…¸ë“œì´ë¦„ í™•ì¸
#
# - kubectl taint nodes <ë…¸ë“œì´ë¦„> <key>=<value>:<effect>
# - nodes : ë¦¬ì†ŒìŠ¤ ìœ í˜• (taintë¥¼ ì„¤ì •í•  ëŒ€ìƒì€ node)
# - <effect> : NoSchedule, PreferNoSchedule, NoExecute (taintì˜ ë™ì‘ ë°©ì‹)
# - NoSchedule : ì¡°ê±´ì„ ë§Œì¡±í•˜ì§€ ì•Šìœ¼ë©´ ì ˆëŒ€ ìŠ¤ì¼€ì¤„ë˜ì§€ ì•ŠìŒ
# - PreferNoSchedule : ê°€ëŠ¥í•˜ë©´ ìŠ¤ì¼€ì¤„ ì•ˆ í•˜ì§€ë§Œ, ë¶ˆê°€í”¼í•˜ë©´ ë°°ì¹˜ ê°€ëŠ¥
# - NoExecute : ì¡°ê±´ ë¶ˆë§Œì¡± ì‹œ ê¸°ì¡´ì— ìˆë˜ Podë„ í‡´ì¶œë¨
# - kubectl taint nodes love-cluster-worker role=work-1:NoSchedule
# - kubectl taint nodes love-cluster-worker type=job:NoSchedule
#
# - kubectl label nodes love-cluster-worker name=oppa-love-node
# - kubectl get nodes --show-labels
# - kubectl label node love-cluster-worker emoji=ğŸ’—
# # ì¸í”„ë¼ ì„¤ì¹˜
#helm install infra ./infra -f values-infra.yaml

# ë°°ì¹˜ ì¡ ì•± ë°°í¬
#helm install job ./batch-job -f values-job.yaml

# SCDF Task ì•± ë°°í¬
#helm install task ./batch-task -f values-task.yaml


# (ì„ íƒ) ì „ì—­ ê³µí†µ ì„¤ì • â€“ í—¬í¼ë“¤ì´ ì°¸ì¡°í•  ìˆ˜ ìˆìŒ
# ì´ ì„¤ì •ì€ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ì— ê³µí†µìœ¼ë¡œ ì ìš©ë˜ëŠ” ê°’ë“¤ë¡œ,
# ì˜ˆë¥¼ ë“¤ì–´ ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬, Pull Secret, Pod ì–´ë…¸í…Œì´ì…˜ ë“±ì„ ì •ì˜í•©ë‹ˆë‹¤.
# ì´ ê°’ë“¤ì€ ê° ì»´í¬ë„ŒíŠ¸ì˜ values.yamlì—ì„œ ì°¸ì¡°ë˜ì–´ ì‚¬ìš©ë©ë‹ˆë‹¤.
# ì˜ˆë¥¼ ë“¤ì–´, ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì„¤ì •í•˜ë©´ ëª¨ë“  ì»´í¬ë„ŒíŠ¸ê°€ í•´ë‹¹ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
# ì˜ˆì‹œë¡œ, ì´ë¯¸ì§€ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¥¼ ì‚¬ì„¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ë¡œ ì„¤ì •í•˜ê±°ë‚˜,
# ì´ë¯¸ì§€ Pull Secretì„ ì§€ì •í•˜ì—¬ ì¸ì¦ëœ ë ˆì§€ìŠ¤íŠ¸ë¦¬ì—ì„œ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
# ì´ ì„¤ì •ì€ Helm ì°¨íŠ¸ì˜ values.yaml íŒŒì¼ì—ì„œ ì •ì˜ë˜ë©°,
# ê° ì»´í¬ë„ŒíŠ¸ì˜ values.yaml íŒŒì¼ì—ì„œ ì°¸ì¡°í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

global:
  podAnnotations: {}           # ëª¨ë“  Podì— ê³µí†µìœ¼ë¡œ ì¶”ê°€í•  ì–´ë…¸í…Œì´ì…˜(ì»´í¬ë„ŒíŠ¸ë³„ ë¡œì»¬ê°’ê³¼ merge)
  # imageRegistry: ""            # ì‚¬ì„¤ ë ˆì§€ìŠ¤íŠ¸ë¦¬ ì‚¬ìš© ì‹œ "registry.example.com"
  # imagePullSecrets: []         # ["regcred"] ë“±
  # podAnnotations: {}           # ëª¨ë“  Podì— ê³µí†µìœ¼ë¡œ ì¶”ê°€í•  ì–´ë…¸í…Œì´ì…˜(ì»´í¬ë„ŒíŠ¸ë³„ ë¡œì»¬ê°’ê³¼ merge)


batchJobs:
  enabled: true
  jobs:
    - name: batch-job-01

      mode: job         # job | cron | deployment ëª¨ë“œ ì„ íƒ

      image: 
        repository: neo-batch-job
        tag: "0.0.1"
        pullPolicy: IfNotPresent
        # Always : ë§¤ë²ˆ ìƒˆ ì´ë¯¸ì§€ Pull (latest íƒœê·¸ë‚˜ ê°œë°œ í™˜ê²½ì—ì„œ)
        # IfNotPresent : ë¡œì»¬ì— ì—†ìœ¼ë©´ Pull (í…ŒìŠ¤íŠ¸ / ë°°í¬ìš© ê°œë°œ ì´ë¯¸ì§€)
        # Never : ì ˆëŒ€ Pull ì•ˆ í•¨ (ë¡œì»¬ì—ì„œ ë§Œë“  ì´ë¯¸ì§€ë§Œ ì‚¬ìš©í•  ë•Œ Kind ë“±)

        # ì‹¤í–‰ command/argsëŠ” ê¼­ ë°°ì—´ë¡œ, ë§Œì¼ docker buildì—ì„œ dockerfileì˜ ë‚´ìš© ì¤‘ ENTRYPOINT ["java","-jar","/app/app.jar"] ì—†ì´ ë§Œë“¤ì–´ì§„ ì´ë¯¸ì§€ ì¸ ê²½ìš°, ì•„ë˜ì˜ ENTRYPOINT ì§€ì • í•„ìš”.
        # ì´ë¯¸ì§€ì—ì„œ ENTRYPOINT ì§€ì • í™•ì¸ : docker image inspect neo-batch-job:0.0.1 --format "Entrypoint={{json .Config.Entrypoint}} Cmd={{json .Config.Cmd}}"
        # Kubernetes ê·œì¹™(ì§„ì§œ ë™ì‘)
        # ì´ë¯¸ì§€ì—ëŠ” ë‘ ê¸°ë³¸ê°’ì´ ìˆì„ ìˆ˜ ìˆë‹¤:
        #   - ENTRYPOINT: ê¸°ë³¸ ì‹¤í–‰ íŒŒì¼
        #   - CMD: ê¸°ë³¸ ì¸ì(ì˜µì…˜)
        # Pod/ì»¨í…Œì´ë„ˆ ìŠ¤í™ì—ì„œ:
        # commandëŠ” ì´ë¯¸ì§€ì˜ ENTRYPOINTë¥¼ ë®ì–´ì”Œìš´ë‹¤.
        # argsëŠ” ì´ë¯¸ì§€ì˜ CMDë¥¼ ë®ì–´ì”Œìš´ë‹¤. 

      # command: ["java", "-jar", "/app/app.jar"] // ë³´í†µì€ docker imagesì— ENTRYPOINTê°€ í¬í•¨ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ì´ ë¶€ë¶„ì„ ìƒëµí•œë‹¤.
      
      args:
        - "--spring.profiles.active=dev"
        - "--spring.config.additional-location=/config/" # Spring batch-jobì´ ConfigMapìœ¼ë¡œ ë§ˆìš´íŠ¸í•œ ì„¤ì •íŒŒì¼ ì½ê¸°
        - "--rtm.batch.job.start=202507091730"
        - "--rtm.batch.job.end=202507091740"
        - "--rtm.batch.job.chunk=200"
        - "--rtm.batch.job.interval=10"
        - "--rtm.batch.job.delay=5"

      # spring batch(Non app)ì´ë©´ ì›¹ ë¹„í™œì„± + OOM ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
      env:
        - name: SPRING_MAIN_WEB_APPLICATION_TYPE
          value: "none"
        - name: JAVA_TOOL_OPTIONS
          value: "-XX:+ExitOnOutOfMemoryError -XX:MaxRAMPercentage=75.0"
        # - name: SPRING_CONFIG_ADDITIONAL_LOCATION
        #   value: "/config/"   # ì´ ê²½ë¡œì˜ application.yamlì„ ì¶”ê°€ë¡œ ë¡œë”©

      # spring app ì¸ ê²½ìš°.
      # env: 
      #   - name: springProfile
      #     value: local 
      #   - name: jobCron 
      #     value: "4,9,14,19,24,29,34,39,44,49,54,59 * * * *"

      # ë¦¬ì†ŒìŠ¤ ê¸°ë³¸ì¹˜
      resources:
        requests: { cpu: "250m", memory: "256Mi" }
        limits:   { cpu: "500m", memory: "640Mi" }

      # resources:
      #   limits:
      #     cpu: 500m
      #     memory: 640Mi
      #   requests:
      #     cpu: 250m
      #     memory: 256Mi

      # 1íšŒ ì‹¤í–‰ Job ì „ìš©(ì„ íƒ)
      job:
        restartPolicy: OnFailure         # Job/CronJobì¸ ê²½ìš° Never/OnFailure
        parallelism: 1
        completions: 1
        backoffLimit: 1
        activeDeadlineSeconds: 600       # 10ë¶„ ìƒí•œ(ë¬´í•œëŒ€ê¸° ë°©ì§€)
        ttlSecondsAfterFinished: 7200    # ì™„ë£Œ 2h í›„ ì •ë¦¬

      # ì£¼ê¸° ì‹¤í–‰ Cron ì „ìš©(ì„ íƒ)
      cron:
        restartPolicy: OnFailure         # Job/CronJobì¸ ê²½ìš° Never/OnFailure
        schedule: "*/5 * * * *"      # mode: cronì¼ ë•Œë§Œ ì‚¬ìš©.
        # 5ë¶„ ì£¼ê¸° (ì„¤ì •ìˆœì„œ : ë¶„ ì‹œ ì¼ ì›” ìš”ì¼)
        # ë™ì¼ ì‹œê°„ ì—¬ëŸ¬ jobì„ ì‹¤í–‰ ì‹œ ë¶€í•˜ ë°œìƒí•˜ê¸° ë•Œë¬¸ì— íŠ¹ì • ì‹œê°„ìœ¼ë¡œ ë‚˜ëˆ„ì›Œ ì‹œì‘ ì‹œ.
        # "1,6,11,16,21,26,31,36,41,46,51,56 * * * *" 
        # "2,7,12,17,22,27,32,37,42,47,52,57 * * * *" 
        # "3,8,13,18,23,28,33,38,43,48,53,58 * * * *" 
        # "4,9,14,19,24,29,34,39,44,49,54,59 * * * *" 

        # */5 * * * * = ë§¤ 5ë¶„(0,5,10,15,â€¦)
        # ì•ˆì „í•œ ì˜¤í”„ì…‹ ë¶„ì‚°(ì„œë¡œ ì‹œì‘ ì‹œê°ì„ ì–´ê¸‹ë‚˜ê²Œ):
        # 1-59/5 * * * * â†’ 1,6,11,16,â€¦
        # 2-59/5 * * * * â†’ 2,7,12,17,â€¦
        # 3-59/5 * * * * â†’ 3,8,13,18,â€¦
        # 4-59/5 * * * * â†’ 4,9,14,19,â€¦

        timeZone: "Asia/Seoul"       # k8s 1.27+ì—ì„œë§Œ ì§€ì›. ë¯¸ë§Œì¸ë©´ ì§€ì›Œë„ ë¨.
        concurrencyPolicy: "Forbid"  # ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        startingDeadlineSeconds: 120
        successfulJobsHistoryLimit: 2
        failedJobsHistoryLimit: 1

      deployment:
        replicaCount: 1
        restartPolicy: Always   # Deploymentì˜ PodëŠ” í•­ìƒ Always. 
        # Job/CronJobì¸ ê²½ìš° Never/OnFailure
        # Always : í•­ìƒ ì¬ ì‹œì‘ (Deployment)
        # OnFailure : ì‹¤íŒ¨ ì‹œ ì¬ ì‹œì‘ (Job / Pod)
        # Never : ì ˆëŒ€ ì¬ ì‹œì‘ ì•ˆí•¨ (Job / Pod)
      
      service:             # Job/TaskëŠ” ë‹¨ë°œì„± ì‹¤í–‰ì´ë¯€ë¡œ ë³´í†µ ServiceëŠ” í•„ìš” ì—†ìŒ. Deployment ëª¨ë“œë¡œ ì‹¤í–‰í•˜ëŠ” ê²½ìš°ì—ë§Œ Serviceê°€ í•„ìš”í•  ìˆ˜ ìˆìŒ.
        enabled: false     # false ì¸ ê²½ìš° ServiceëŠ” í•„ìš” ì—†ìŒ (job/taskëŠ” ë‹¨ë°œì„± ì‹¤í–‰ì´ë¯€ë¡œ í†µì‹  ë…¸ì¶œ ë¶ˆí•„ìš”)
        type: ClusterIP    # ë‚´ë¶€ í´ëŸ¬ìŠ¤í„°ìš© ì„œë¹„ìŠ¤ íƒ€ì…(K8së‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥ : ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ë¼ë¦¬ì˜ í†µì‹ ìš©)
        port: 8080         # ê¸°ë³¸ ì„œë¹„ìŠ¤(dbë“±) í¬íŠ¸ë¡œ í´ëŸ¬ìŠ¤í„° ì•ˆì—ì„œ ì„œë¹„ìŠ¤ê°€ ë…¸ì¶œë˜ëŠ” ê°€ìƒ í¬íŠ¸ (ì´ì™¸ì—, targetPort : Pod ì»¨í…Œì´ë„ˆ í¬íŠ¸)
        # nodePort: 30080  # NodePortëŠ” 30000 ~ 32767 ë²”ìœ„ë§Œ í—ˆìš©, ìƒëµ ì‹œ k8sì—ì„œ ìë™ í• ë‹¹. ì¤‘ë³µ ì„¤ì •í•˜ë©´ ì•ˆë˜ëŠ” í¬íŠ¸ë²ˆí˜¸. kind í…ŒìŠ¤íŠ¸ì‹œì—ë§Œ ì‚¬ìš©. ìƒëµí•˜ì—¬ ìë™í• ë‹¹ ì¶”ì²œ. 

      datasource: # ì™¸ë¶€ì˜ dbë¥¼ sql íŒ¨ì¹˜ ë° í˜ì´ì§•í•˜ì—¬ read ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©. í–¥í›„ ìš´ì˜ ì‹œ ë‚´ìš© ë³€ê²½ í•„ìš”)
        driver_class_name: org.mariadb.jdbc.Driver
        url: jdbc:mariadb://job01-datasource.default.svc.cluster.local:3306/jobdb
        username: user
        password: root
      datasource_sub: # ì™¸ë¶€ì˜ dbë¥¼ sql íŒ¨ì¹˜ ë° í˜ì´ì§•í•˜ì—¬ read ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©. í–¥í›„ ìš´ì˜ ì‹œ ë‚´ìš© ë³€ê²½ í•„ìš”)
        enabled: true
        driver_class_name: com.mysql.cj.jdbc.Driver 
        url: jdbc:mysql://job01-datasource-sub.default.svc.cluster.local:3306/jobdb
        username: user
        password: root
      influx:
        url: http://influxdb:8086
        logLevel: BODY
        readTimeout: 5s
        writeTimeout: 5s
        connectTimeout: 5s

      nodeSelector:                   # í•´ë‹¹ Podê°€ ë°°ì¹˜ë  Nodeë¥¼ labelë¡œ ì§€ì •
        role: work-1                  # label key: 'role', value: 'work-1' ì¸ ë…¸ë“œì—ë§Œ ë°°ì¹˜
      affinity:                       # (ì„ íƒì‚¬í•­) NodeAffinity / PodAffinity ë“± ì •êµí•œ ë°°ì¹˜ ì „ëµ
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: role
                  operator: In
                  values:
                    - work-1          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨
      tolerations:                    # Taintsê°€ ê±¸ë¦° ë…¸ë“œì—ë„ í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë°°ì¹˜ í—ˆìš© (kubectl taint nodes work-1 type=job:NoSchedule)
        - key: "type"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
          operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
          value: "job"                # í•´ë‹¹ ê°’ì´ "job"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
          effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨

      volumeMounts:
        - name: config-volume
          mountPath: /config          # ì„¤ì •íŒŒì¼ì´ ë§ˆìš´íŠ¸ë  ê²½ë¡œ
          readOnly: true              # ì½ê¸° ì „ìš©
      volumes:                        # ì»¨í…Œì´ë„ˆ ì™¸ë¶€ì—ì„œ ConfigMapì„ ë§ˆìš´íŠ¸í•˜ë ¤ë©´ volumeMountsì™€ valumes ë‘˜ ë‹¤ ì„¤ì • í•„ìš”.
        - name: config-volume
          configMap:                  # volumeMounts + volumes : application.yml ë˜ëŠ” application-prod.yml ë“± Spring Boot ì•± ì„¤ì •íŒŒì¼ì„ Kubernetes ConfigMapìœ¼ë¡œ ë§Œë“¤ì–´ì„œ Pod ë‚´ë¶€ì— ë§ˆìš´íŠ¸í•´ ì‚¬ìš©í•˜ê¸° ìœ„í•¨ 
            name: batch-job-01-config # ì°¸ì¡°í•  ConfigMap ì´ë¦„ (batch job appì˜ JVM ì‹¤í–‰ ì‹œ --spring.config.additional-location=/config/ ì˜µì…˜ì„ í†µí•´ ì´ íŒŒì¼ì„ ì½ê²Œ í•  ìˆ˜ ìˆë‹¤. í´ëŸ¬ìŠ¤í„°ì— ì‹¤ì œ ì¡´ì¬í•´ì•¼ í•¨.
      configMap:                      # ConfigMap ë§Œë“œëŠ” ë°©ë²• : kubectl create configmap batch-job-01-config --from-file=application.yml (ì´í›„, Helmì—ì„œëŠ” configMap.name: batch-job-01-configìœ¼ë¡œ ì°¸ì¡°í•˜ë©´ ëœë‹¤)
        enabled: true                 # false ë©´ Helmì´ ConfigMapì„ ë§Œë“¤ì§€ ì•ŠìŒ. trueë¡œ í•´ì•¼ ì•„ë˜ name/files ì˜µì…˜ì´ ì ìš©ë¨.
        name: batch-job-01-config
        files: ["application.yaml"]
        # - application.yaml
        # enabled: falseì¸ ê²½ìš°, íŒŒì¼ ë§ˆìš´íŠ¸ ì•ˆ ì”€. datasource/influx ë“±ì€ ìœ„ â€˜envìš© í…œí”Œë¦¿â€™ì´ ì½ì–´ envë¡œ ë³€í™˜

      # Prometheus ìŠ¤í¬ë© ì„¤ì •
      # Skipperì˜ Actuator ì—”ë“œí¬ì¸íŠ¸ë¥¼ Prometheusê°€ ìŠ¤í¬ë©
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/actuator/prometheus"
        prometheus.io/port: "8080"

      # Spring App ì´ë©´ HTTP í”„ë¡œë¸Œ ì‚¬ìš©. Non App Spring Batch ì´ë©´ ë¶ˆ í•„ìš”í•œ ìš”ì†Œ
      # livenessProbe:                  # ì•±ì´ ì‚´ì•„ ìˆëŠ”ì§€ í™•ì¸(ì£½ì—ˆìœ¼ë©´ ìë™ ì¬ ì‹œì‘)
      #   httpGet:
      #     path: /actuator/health/liveness # Spring Boot actuatorì˜ /health/liveness ì•¤ë“œí¬ì¸íŠ¸ë¥¼ ì‚¬ìš©
      #     port: 8080
      #   initialDelaySeconds: 30
      #   periodSeconds: 10
      # readinessProbe:                 # ì•±ì´ ì¤€ë¹„ëëŠ”ì§€ í™•ì¸(ì¤€ë¹„ë˜ê¸° ì „ì—ëŠ” íŠ¸ë˜í”½ ì°¨ë‹¨)
      #   httpGet:
      #     path: /actuator/health/readiness
      #     port: 8080
      #   initialDelaySeconds: 15
      #   periodSeconds: 5

    - name: batch-job-02

      mode: deployment 

      image:
        repository: neo-batch-job
        tag: "0.0.1"
        pullPolicy: IfNotPresent

      # command: ["java", "-jar", "/app/app.jar"]

      args: 
        - "--spring.profiles.active=dev"
        - "--spring.config.additional-location=/config/" # Spring batch-jobì´ ConfigMapìœ¼ë¡œ ë§ˆìš´íŠ¸í•œ ì„¤ì •íŒŒì¼ ì½ê¸°
        - "--rtm.batch.job.start=202507091730"
        - "--rtm.batch.job.end=202507091740"
        - "--rtm.batch.job.chunk=200"
        - "--rtm.batch.job.interval=10"
        - "--rtm.batch.job.delay=5"

      # spring batch(Non app)ì´ë©´ ì›¹ ë¹„í™œì„± + OOM ì‹œ ì¦‰ì‹œ ì¢…ë£Œ
      env:
        - name: SPRING_MAIN_WEB_APPLICATION_TYPE
          value: "none"
        - name: JAVA_TOOL_OPTIONS
          value: "-XX:+ExitOnOutOfMemoryError -XX:MaxRAMPercentage=75.0"
        # - name: SPRING_CONFIG_ADDITIONAL_LOCATION
        #  value: "/config/"   # ì´ ê²½ë¡œì˜ application.yamlì„ ì¶”ê°€ë¡œ ë¡œë”©

      # ë¦¬ì†ŒìŠ¤ ê¸°ë³¸ì¹˜
      resources:
        requests: { cpu: "250m", memory: "256Mi" }
        limits:   { cpu: "500m", memory: "640Mi" }

      # Job ì „ìš©(ì„ íƒ)
      job:
        restartPolicy: OnFailure         # Job/CronJobì¸ ê²½ìš° Never/OnFailure
        parallelism: 1
        completions: 1
        backoffLimit: 1
        activeDeadlineSeconds: 680
        ttlSecondsAfterFinished: 7200

      # Cron ì „ìš©(ì„ íƒ)
      cron:
        restartPolicy: OnFailure         # Job/CronJobì¸ ê²½ìš° Never/OnFailure
        schedule: "*/5 * * * *" 
        timeZone: "Asia/Seoul"
        concurrencyPolicy: "Forbid"
        startingDeadlineSeconds: 120
        successfulJobsHistoryLimit: 2
        failedJobsHistoryLimit: 1

      deployment:
        replicaCount: 1
        restartPolicy: Always # OnFailure : ì‹¤íŒ¨ ì‹œ ì¬ ì‹œì‘ (Job / Pod)
        
      service:
        enabled: true    
        type: ClusterIP 
        port: 8081
        # nodePort: 30081

      datasource: # ì™¸ë¶€ì˜ dbë¥¼ sql íŒ¨ì¹˜ ë° í˜ì´ì§•í•˜ì—¬ read ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©. í–¥í›„ ìš´ì˜ ì‹œ ë‚´ìš© ë³€ê²½ í•„ìš”)
        driver_class_name: com.mysql.cj.jdbc.Driver 
        url: jdbc:mysql://job02-datasource.default.svc.cluster.local:3306/jobdb
        username: user
        password: root
      datasource_sub: # ì™¸ë¶€ì˜ dbë¥¼ sql íŒ¨ì¹˜ ë° í˜ì´ì§•í•˜ì—¬ read ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©. í–¥í›„ ìš´ì˜ ì‹œ ë‚´ìš© ë³€ê²½ í•„ìš”)
        enabled: true
        driver_class_name: com.mysql.cj.jdbc.Driver 
        url: jdbc:mysql://job02-datasource-sub.default.svc.cluster.local:3306/jobdb
        username: user
        password: root
      influx:
        url: http://influxdb:8086
        logLevel: BODY
        readTimeout: 5s
        writeTimeout: 5s
        connectTimeout: 5s

      nodeSelector:
        role: work-1

      affinity:                       # (ì„ íƒì‚¬í•­) NodeAffinity / PodAffinity ë“± ì •êµí•œ ë°°ì¹˜ ì „ëµ
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: role
                  operator: In
                  values:
                    - work-1          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨
      tolerations:                    # Taintsê°€ ê±¸ë¦° ë…¸ë“œì—ë„ í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë°°ì¹˜ í—ˆìš©
        - key: "type"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
          operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
          value: "job"                # í•´ë‹¹ ê°’ì´ "job"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
          effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨

      volumeMounts:
        - name: config-volume
          mountPath: /config          # ì„¤ì •íŒŒì¼ì´ ë§ˆìš´íŠ¸ë  ê²½ë¡œ
          readOnly: true              # ì½ê¸° ì „ìš©
      volumes:
        - name: config-volume
          configMap:
            name: batch-job-02-config    # ì°¸ì¡°í•  ConfigMap ì´ë¦„
      configMap:
        enabled: true
        name: batch-job-02-config
        files: ["application.yaml"]

      # Prometheus ìŠ¤í¬ë© ì„¤ì •
      # Skipperì˜ Actuator ì—”ë“œí¬ì¸íŠ¸ë¥¼ Prometheusê°€ ìŠ¤í¬ë©
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/actuator/prometheus"
        prometheus.io/port: "8080"

      # files:
      #   - application.yaml
      # livenessProbe:
      #   httpGet:
      #     path: /actuator/health/liveness
      #     port: 8080
      #   initialDelaySeconds: 30
      #   periodSeconds: 10
      # readinessProbe:
      #   httpGet:
      #     path: /actuator/health/readiness
      #     port: 8080
      #   initialDelaySeconds: 15
      #   periodSeconds: 5

batchTasks:
  enabled: true
  tasks:
    - name: batch-task-01
      mode: task 

      image:
        repository: neo-batch-task
        tag: "0.0.1"
        pullPolicy: IfNotPresent

      # command: ["java", "-jar", "/app/app.jar"]

      args:
        - "--spring.cloud.task.name=task01"
        - "--spring.config.additional-location=/config/" # Spring batch-taskê°€ ConfigMapìœ¼ë¡œ ë§ˆìš´íŠ¸í•œ ì„¤ì •íŒŒì¼ ì½ê¸°
        - "--rtm.batch.job.start=202507091730"
        - "--rtm.batch.job.end=202507091740"
        - "--rtm.batch.job.chunk=200"
        - "--rtm.batch.job.interval=10"
        - "--rtm.batch.job.delay=5"

      env:
        - name: SPRING_MAIN_WEB_APPLICATION_TYPE
          value: "none"
        - name: JAVA_TOOL_OPTIONS
          value: "-XX:+ExitOnOutOfMemoryError -XX:MaxRAMPercentage=75.0"
        - name: SPRING_PROFILES_ACTIVE
          value: "local"
        - name: TASK_EXECUTION_ID
          value: "ID0001"
        - name: task_name
          value: "batch_task_01"
        # - name: SPRING_CONFIG_ADDITIONAL_LOCATION
        #  value: "/config/"   # ì´ ê²½ë¡œì˜ application.yamlì„ ì¶”ê°€ë¡œ ë¡œë”©

      # ë¦¬ì†ŒìŠ¤ ê¸°ë³¸ì¹˜
      resources:
        requests: { cpu: "250m", memory: "256Mi" }
        limits:   { cpu: "500m", memory: "640Mi" }

      # Job ì „ìš©(ì„ íƒ)
      task:
        parallelism: 1                  # ë³‘ë ¬ ì‹¤í–‰ ìˆ˜
        completions: 1                  # ì™„ë£Œ íšŸìˆ˜
        backoffLimit: 1                 # ì¬ì‹œë„ íšŸìˆ˜
        activeDeadlineSeconds: 680      # 10ë¶„ ìƒí•œ(ë¬´í•œëŒ€ê¸° ë°©ì§€)
        ttlSecondsAfterFinished: 7200   # ì™„ë£Œ 2h í›„ ì •ë¦¬

      # Cron ì „ìš©(ì„ íƒ)
      cron:
        schedule: "*/5 * * * *"         # 5ë¶„ ì£¼ê¸° (ì„¤ì •ìˆœì„œ : ë¶„ ì‹œ ì¼ ì›” ìš”ì¼)
        timeZone: "Asia/Seoul"          # (k8s >= 1.27) í´ëŸ¬ìŠ¤í„° íƒ€ì„ì¡´ ì‚¬ìš©. ë¯¸ì§€ì› ë²„ì „ì´ë©´ ì£¼ì„ ì²˜ë¦¬ í•„ìš”
        concurrencyPolicy: "Forbid"     # ë™ì‹œì— ê²¹ì¹˜ëŠ” ì‹¤í–‰ ë°©ì§€: Forbid(ê¸°ë³¸ ê¶Œì¥) / Replace / Allow
        startingDeadlineSeconds: 120    # ìŠ¤ì¼€ì¤„ ì§€ì—° í—ˆìš© ì‹œê°„(ì´ˆ). ì§€ë‚¬ìœ¼ë©´ ì´ë²ˆì€ ê±´ë„ˆëœ€(ì˜µì…˜)
        successfulJobsHistoryLimit: 2   # ë³´ê´€í•  ì„±ê³µí•œ ì¡ ê¸°ë¡ ìˆ˜
        failedJobsHistoryLimit: 1       # ë³´ê´€í•  ì‹¤íŒ¨í•œ ì¡ ê¸°ë¡ ìˆ˜ 

      # Deployment ì „ìš©(ì„ íƒ)
      deployment:
        replicaCount: 1
        restartPolicy: Always           # Deploymentì˜ PodëŠ” í•­ìƒ Alwaysì—¬ì„œ, valuesì— ë‹¤ë¥¸ ê°’ ë„£ì–´ë„ ì˜ë¯¸ê°€ ì—†ìŒ.
                                        # í…œí”Œë¦¿ì—ì„œ ì˜ëª» ì“°ë©´ ê²€ì¦ì— ê±¸ë¦´ ìˆ˜ ìˆìœ¼ë‹ˆ ë¬´ì‹œí•˜ê±°ë‚˜ ê³ ì • ê¶Œì¥
        
      service:
        enabled: false    # false ì¸ ê²½ìš° ServiceëŠ” í•„ìš” ì—†ìŒ (taskëŠ” ë‹¨ë°œì„± ì‹¤í–‰ì´ë¯€ë¡œ í†µì‹  ë…¸ì¶œ ë¶ˆí•„ìš”) í˜„ì¬ëŠ” í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œ trueë¡œ í•´ì„œ í…ŒìŠ¤íŠ¸ í•´ë´„.
        type: ClusterIP   # ë‚´ë¶€ í´ëŸ¬ìŠ¤í„°ìš© ì„œë¹„ìŠ¤ íƒ€ì…(K8së‚´ë¶€ì—ì„œë§Œ ì ‘ê·¼ ê°€ëŠ¥)
        port: 8090
        # nodePort: 30090   # NodePortëŠ” 30000 ~ 32767 ë²”ìœ„ë§Œ í—ˆìš©

      datasource: # ì™¸ë¶€ì˜ dbë¥¼ sql íŒ¨ì¹˜ ë° í˜ì´ì§•í•˜ì—¬ read ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©. í–¥í›„ ìš´ì˜ ì‹œ ë‚´ìš© ë³€ê²½ í•„ìš”)
        driver_class_name: org.mariadb.jdbc.Driver
        url: jdbc:mariadb://task01-datasource.default.svc.cluster.local:3306/taskdb
        username: user
        password: root
      datasource_sub: # ì™¸ë¶€ì˜ dbë¥¼ sql íŒ¨ì¹˜ ë° í˜ì´ì§•í•˜ì—¬ read ì‹œ ì‚¬ìš© (í˜„ì¬ëŠ” ë¯¸ì‚¬ìš©. í–¥í›„ ìš´ì˜ ì‹œ ë‚´ìš© ë³€ê²½ í•„ìš”)
        enabled: false
        driver_class_name: com.mysql.cj.jdbc.Driver 
        url: jdbc:mysql://task01-datasource-sub.default.svc.cluster.local:3306/taskdb
        username: user
        password: root
      influx:
        url: http://influxdb:8086
        logLevel: BODY
        readTimeout: 5s
        writeTimeout: 5s
        connectTimeout: 5s

      arguments:
        - "--runDate=2025-07-10" 
          # task launch my-batch-task --arguments "--runData=2005-07-10" ì‹œ 
          # spring.batch.job.enabled=true ì¼ ê²½ìš°, ìë™ìœ¼ë¡œ JobParameterë¡œ ì¸ì‹
          # JobLauncherApplicationRunnerê°€ ìë™ ì‹¤í–‰

      nodeSelector:
        role: work-2
      affinity:                       # (ì„ íƒì‚¬í•­) NodeAffinity / PodAffinity ë“± ì •êµí•œ ë°°ì¹˜ ì „ëµ
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                - key: role
                  operator: In
                  values:
                    - work-2          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨
      tolerations:                    # Taintsê°€ ê±¸ë¦° ë…¸ë“œì—ë„ í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë°°ì¹˜ í—ˆìš©
        - key: "type"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
          operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
          value: "task"               # í•´ë‹¹ ê°’ì´ "task"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
          effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨

      volumeMounts:
        - name: config-volume
          mountPath: /config          # ì„¤ì •íŒŒì¼ì´ ë§ˆìš´íŠ¸ë  ê²½ë¡œ
          readOnly: true              # ì½ê¸° ì „ìš©
      volumes:
        - name: config-volume
          configMap:
            name: batch-task-01-config    # ì°¸ì¡°í•  ConfigMap ì´ë¦„
      configMap:
        enabled: true
        name: batch-task-01-config
        files : ["application.yaml"]

      # Prometheus ìŠ¤í¬ë© ì„¤ì •
      # Skipperì˜ Actuator ì—”ë“œí¬ì¸íŠ¸ë¥¼ Prometheusê°€ ìŠ¤í¬ë©
      podAnnotations:
        prometheus.io/scrape: "true"
        prometheus.io/path: "/actuator/prometheus"
        prometheus.io/port: "8080"

      # livenessProbe:
      #   httpGet:
      #     path: /actuator/health/liveness
      #     port: 8080
      #   initialDelaySeconds: 30
      #   periodSeconds: 10
      # readinessProbe:
      #   httpGet:
      #     path: /actuator/health/readiness
      #     port: 8080
      #   linitialDelaySeconds: 15
      #   periodSeconds: 5


# =========================
# MySQL
# =========================
mysql:
  enabled: true

  image:
    repository: mysql
    tag: "8.0"
    pullPolicy: IfNotPresent

  env:
    - name: MYSQL_ROOT_PASSWORD
      valueFrom:
        secretKeyRef:
          name: mysql-auth
          key: root
    - name: MYSQL_DATABASE
      value: demo
    - name: MYSQL_USER
      value: neodain
    - name: MYSQL_PASSWORD    # value: Kht72@eye1
      valueFrom:
        secretKeyRef:
          name: mysql-auth
          key: userpass

  service:
    type: NodePort            # NodePort : ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
    port: 3306
    nodePort: 30306

  persistence:
    enabled: true             # false : ë””ìŠ¤í¬ ì‚¬ìš©ì•ˆí•¨(ì¼ì‹œì ì¸ í…ŒìŠ¤íŠ¸ ì‹œ)
    mountPath: /var/lib/mysql
    storageClass: standard    # standard, gp2, hostpath
    size: 1Gi                 # persistence.enabled: true, storageClass, size ì„¤ì • : PVCë¥¼ Helm Chart ì•ˆì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±
    # existingClaim: mysql-pvc  # ì´ë¯¸ í´ëŸ¬ìŠ¤í„°ì— ìƒì„±ëœ mysql-pvcë¼ëŠ” PVCë¥¼ ì‚¬ìš©í•˜ê² ë‹¤ëŠ” ì˜ë¯¸ë¡œ ì‚¬ì „ì— mysql-pvc.yaml ë“±ìœ¼ë¡œ ì •ì˜ ë˜ì–´ ìˆì–´ì•¼ í•œë‹¤.
  nodeSelector:
    role: work-1

  # í…œí”Œë¦¿ì—ì„œ merge ê°€ëŠ¥(ì—†ìœ¼ë©´ ë¬´ì‹œ)
  podAnnotations: {}

  # (ì„ íƒ) ë¦¬ì†ŒìŠ¤ ê¸°ë³¸ê°’ â€“ í…œí”Œë¦¿ì€ ì—†ì–´ë„ ë™ì‘í•˜ì§€ë§Œ ìš´ì˜ ê¶Œì¥
  resources:
    requests: { cpu: 100m, memory: 256Mi }
    limits:   { cpu: 500m, memory: 1Gi }

  # (ì„ íƒ) ìŠ¤ì¼€ì¤„ë§ ì„¤ì •
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
            - key: role
              operator: In
              values:
                - work-1          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨ 

  tolerations:
    - key: "role"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
      operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
      value: "work-1"             # í•´ë‹¹ ê°’ì´ "work-1"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
      effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨


# =========================
# MariaDB
# =========================
mariadb:
  enabled: true

  image:
    repository: mariadb
    tag: "10"
    pullPolicy: IfNotPresent

  env:
    - name: MARIADB_ROOT_PASSWORD
      valueFrom:
        secretKeyRef:
          name: mysql-auth
          key: root
    - name: MARIADB_DATABASE
      value: demo
    - name: MARIADB_USER
      value: neodain
    - name: MARIADB_PASSWORD    # value: Kht72@eye1
      valueFrom:
        secretKeyRef:
          name: mysql-auth
          key: userpass

  service:
    type: NodePort            # NodePort : ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
    port: 3306
    nodePort: 30307

  persistence:
    enabled: true
    mountPath: /var/lib/mysql
    storageClass: standard    # standard, gp2, hostpath
    size: 1Gi                 # persistence.enabled: true, storageClass, size ì„¤ì • : PVCë¥¼ Helm Chart ì•ˆì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±
    # existingClaim: mariadb-pvc

  nodeSelector:
    role: work-2

  podAnnotations: {}

  resources:
    requests: { cpu: 100m, memory: 256Mi }
    limits:   { cpu: 500m, memory: 1Gi }

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
            - key: role
              operator: In
              values:
                - work-2          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨ 

  tolerations:
    - key: "role"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
      operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
      value: "work-2"             # í•´ë‹¹ ê°’ì´ "work-2"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
      effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨ 


# =========================
# InfluxDB(v2)
# =========================
influxdb:
  enabled: true

  image:
    repository: influxdb
    tag: "2.7.12" 
    pullPolicy: IfNotPresent

  env:
    - name: DOCKER_INFLUXDB_INIT_MODE
      value: setup
    - name: DOCKER_INFLUXDB_INIT_USERNAME
      value: neodain
    - name: DOCKER_INFLUXDB_INIT_PASSWORD
      value: Kht72@eye1
    - name: DOCKER_INFLUXDB_INIT_ORG
      value: neodain
    - name: DOCKER_INFLUXDB_INIT_BUCKET
      value: neodain
    - name: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN
      valueFrom:
        secretKeyRef:
          name: influxdb-auth
          key: token
          # secret ìƒì„± ì˜ˆ:
          # kubectl create secret generic influxdb-auth --from-literal=token=xxxxxxxxxxxxxxxx
          # kubectl create secret generic influxdb-auth --from-literal=token='<ì‹¤ì œí† í°>' -n <ns>
          # ë˜ëŠ”
          # kubectl create secret generic influxdb-auth --from-literal=token=$(openssl rand -hex 16)
          # ë˜ëŠ” (base64 ì¸ì½”ë”©ëœ ê°’ ì‚¬ìš© ì‹œ)
          # kubectl create secret generic influxdb-auth --from-literal=token=$(echo -n 'xxxxxxxxxxxxxxxx' | base64)
          # kubectl get secret influxdb-admin-token-secret -o yaml
          # data:
          #   token: eHh4eHh4eHh4eHh4eHh4eHg=   # base64 ì¸ì½”ë”©ëœ ê°’
      # value: xxxxxxxxxxxxxxxx 

  service:
    type: NodePort            # NodePort : ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
    port: 8086
    nodePort: 30086

  persistence:
    enabled: true
    mountPath: /var/lib/influxdb2
    storageClass: standard    # standard, gp2, hostpath
    size: 1Gi                 # persistence.enabled: true, storageClass, size ì„¤ì • : PVCë¥¼ Helm Chart ì•ˆì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±
    # existingClaim: influxdb-pvc

  nodeSelector:
    role: control

  podAnnotations: {}

  resources:
    requests: { cpu: 100m, memory: 256Mi }
    limits:   { cpu: 500m, memory: 1Gi }

  affinity: 
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
            - key: role
              operator: In
              values:
                - control          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨

  tolerations:
    - key: "role"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
      operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
      value: "control"            # í•´ë‹¹ ê°’ì´ "control"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
      effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨ 


# =========================
# Grafana
# =========================
grafana:
  enabled: true
  replicaCount: 1            # GrafanaëŠ” ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ìš´ì˜
  image:
    repository: grafana/grafana
    tag: "12.1.1" 
    pullPolicy: IfNotPresent

  service:
    type: NodePort            # NodePort : ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ
    port: 3000
    nodePort: 31000

  persistence:                # persistence.enabled: true, storageClass, size ì„¤ì • : PVCë¥¼ Helm Chart ì•ˆì—ì„œ ë™ì ìœ¼ë¡œ ìƒì„±
    enabled: true
    mountPath: /var/lib/grafana
    storageClass: standard    # standard, gp2, hostpath
    size: 1Gi                 

  admin: 
    existingSecret: grafana-admin-secret   # ì´ ë°©ì‹ ê¶Œì¥
    # user: admin
    # password: admin

  nodeSelector:
    role: control

  # Grafanaì˜ Podì— ì¶”ê°€í•  ì–´ë…¸í…Œì´ì…˜(ì—†ìœ¼ë©´ ë¬´ì‹œ)
  podAnnotations: {}
    
  # (ì„ íƒ) ë¦¬ì†ŒìŠ¤ â€“ ìš´ì˜ ê¶Œì¥
  resources:
    requests: { cpu: 100m, memory: 256Mi }
    limits:   { cpu: 500m, memory: 1Gi }

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
            - key: role
              operator: In
              values:
                - control          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨

  tolerations:
    - key: "role"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
      operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
      value: "control"            # í•´ë‹¹ ê°’ì´ "control"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
      effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨

  # ë°ì´í„°ì†ŒìŠ¤ í”„ë¡œë¹„ì €ë‹ (InfluxDB v2 / Prometheus)
  # GrafanaëŠ” ê¸°ë³¸ìœ¼ë¡  â€œë¹ˆ ìƒíƒœâ€ë¡œ ëœ¨ê³ , UIì—ì„œ ìˆ˜ë™ìœ¼ë¡œ Prometheus/InfluxDB ê°™ì€ ë°ì´í„°ì†ŒìŠ¤ë¥¼ ë“±ë¡í•´ì•¼ ë¨.
  # í•˜ì§€ë§Œ, í”„ë¡œë¹„ì €ë‹ì„ í†µí•´ ìë™ìœ¼ë¡œ ë°ì´í„°ì†ŒìŠ¤ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŒ.
  # í”„ë¡œë¹„ì €ë‹ì€ Grafanaê°€ ì‹œì‘í•  ë•Œ ìë™ìœ¼ë¡œ ë°ì´í„°ì†ŒìŠ¤ë¥¼ ë“±ë¡
  # datasources.yamlì€ ê·¸ ì‘ì—…ì„ ìë™í™”í•˜ëŠ” ì„¤ì • íŒŒì¼.
  # ì´ íŒŒì¼ì€ Helm ì°¨íŠ¸ì˜ values.yamlì—ì„œ ì„¤ì •í•  ìˆ˜ ìˆìŒ.
  # Helm ì°¨íŠ¸ì—ì„œ ì´ íŒŒì¼ì„ /etc/grafana/provisioning/datasources/ ê²½ë¡œì— ë„£ì–´ì£¼ë©´,
  # Grafanaê°€ ì‹œì‘í•  ë•Œ /etc/grafana/provisioning/datasources/*.yamlì„ ì½ê³  ë°ì´í„°ì†ŒìŠ¤ë¥¼ ë§Œë“¤ì–´ ì¤€ë‹¤.
  datasources:
    datasources.yaml:
      apiVersion: 1                # ê³ ì •
      datasources:
        - name: Prometheus         # í™”ë©´ì— ë³´ì¼ ì´ë¦„
          type: prometheus         # ë°ì´í„°ì†ŒìŠ¤ íƒ€ì…
          access: proxy            # Grafanaê°€ í”„ë¡ì‹œë¡œ í˜¸ì¶œ(ì¼ë°˜ì )
          url: http://prometheus-server:9090   # í´ëŸ¬ìŠ¤í„° ë‚´ë¶€ SVC ì£¼ì†Œ
          isDefault: true          # ê¸°ë³¸ ë°ì´í„°ì†ŒìŠ¤ë¡œ ì„¤ì •(í•˜ë‚˜ë§Œ true)
          # editable: false        # (ì„ íƒ) UIì—ì„œ ìˆ˜ì • ê¸ˆì§€
        - name: InfluxDB
          type: influxdb
          access: proxy
          url: http://influxdb:8086
          jsonData:
            version: 2             # InfluxDB v2 ì‚¬ìš©
            organization: neodain
            defaultBucket: neodain
          secureJsonData:
            token: ${INFLUX_TOKEN} # ENVë¡œ ì£¼ì…ëœ í† í° ì°¸ì¡°

  # í™˜ê²½ë³€ìˆ˜ë¡œ InfluxDB í† í° ì„¤ì •
  env:
    - name: DOCKER_INFLUXDB_INIT_ADMIN_TOKEN 
      valueFrom:
        secretKeyRef:
          name: influxdb-auth
          key: token

  # (ì„ íƒ) ëŒ€ì‹œë³´ë“œ ìë™ í”„ë¡œë¹„ì €ë‹
  dashboardsProvider:
    enabled: true
    configMaps:
      - scdf-monitoring-dashboards  # ConfigMapì— json ë„£ì–´ë‘ë©´ ìë™ ë¡œë“œ

  # (ì„ íƒ) Grafanaì˜ ê¸°ë³¸ ëŒ€ì‹œë³´ë“œ ì„¤ì •
  # dashboardsProvider:
  #   enabled: true
  #   configMaps:
  #     - scdf-monitoring-dashboards  # ConfigMapì— json ë„£ì–´ë‘ë©´ ìë™ ë¡œë“œ
  #   dashboards.yaml:
  #     apiVersion: 1
  #     providers:
  #       - name: 'default'
  #         orgId: 1
  #         type: file
  #         disableDeletion: false
  #         editable: true
  #         allowUiUpdates: true
  #         options:
  #           path: /var/lib/grafana/dashboards

# =========================
# Prometheus
# =========================
prometheus:
  enabled: true
  replicaCount: 1            # PrometheusëŠ” ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ìš´ì˜         
  image:
    repository: bitnami/prometheus 
    tag: "3.5.0" 

  server:

    # í…œí”Œë¦¿ì—ì„œ ConfigMap(prometheus.yml)ì— ë°˜ì˜ë¨
    global:
      scrape_interval: "15s"        # ì¶”ê°€: í…œí”Œë¦¿ì—ì„œ ì°¸ì¡° â†’ ê¸°ë³¸ ì œê³µ
      evaluation_interval: "15s"    # ì¶”ê°€: í…œí”Œë¦¿ì—ì„œ ì°¸ì¡° â†’ ê¸°ë³¸ ì œê³µ

    resources:
      requests: { cpu: 200m, memory: 512Mi }
      limits:   { cpu: 500m, memory: 1Gi }

    persistentVolume:
      enabled: true
      storageClass: standard
      size: 10Gi

    # ë³´ì¡´ê¸°ê°„/í¬ê¸° ì œí•œ (í…œí”Œë¦¿ argsì— ì£¼ì…)
    extraFlags:
      - --storage.tsdb.retention.time=15d
      - --storage.tsdb.retention.size=8GB

    nodeSelector: { role: control }

    # (ì„ íƒ) ì„œë¹„ìŠ¤ íƒ€ì… â€“ í…œí”Œë¦¿ì—ì„œ digë¡œ ì¡°íšŒ (ë¯¸ì§€ì • ì‹œ ClusterIP)
    service:
      port: 9090
      type: ClusterIP
      # nodePort: 32090   # NodePortëŠ” 30000 ~ 32767 ë²”ìœ„ë§Œ í—ˆìš©, ìƒëµ ì‹œ k8sì—ì„œ ìë™ í• ë‹¹. 
  
      # nodePort: 30090

    # (ì„ íƒ) íŒŒë“œ ì–´ë…¸í…Œì´ì…˜ ì¶”ê°€ ì§€ì (ì—†ìœ¼ë©´ ë¬´ì‹œ)
    podAnnotations: {}
    affinity: {}
    tolerations: []

    # SCDF/Skipper/ë°°ì¹˜ì•± ìŠ¤í¬ë© ì„¤ì •(Actuator /actuator/prometheus)
    extraScrapeConfigs:
      - job_name: 'scdf-server'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: true
            source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
            regex: (.+);(.+)
            target_label: __address__
            replacement: ${1}:${2}
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
      - job_name: 'skipper-server'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: true
            source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
            regex: (.+);(.+)
            target_label: __address__
            replacement: ${1}:${2}
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
      - job_name: 'spring-boot-apps'
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - action: keep
            regex: true
            source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          - source_labels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
            regex: (.+);(.+)
            target_label: __address__
            replacement: ${1}:${2}
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)


# =========================
# SCDF (Server + Skipper)
# =========================
scdf:
  enabled: true 
  server:
    replicaCount: 1            # SCDF ì„œë²„ëŠ” ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ìš´ì˜
    image:
      repository: "bitnami/spring-cloud-dataflow"
      tag: "2.11.5"
      pullPolicy: IfNotPresent

    service:
      type: NodePort      # NodePort : ì™¸ë¶€ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ë…¸ì¶œ, ìš´ì˜ì€ Ingressë¡œ ë…¸ì¶œ    
      port: 8080 
      nodePort: 32080

    resources:
      requests: { cpu: 500m, memory: 1024Mi }
      limits:   { cpu: "1",  memory: 2048Mi }

    # ë‚´ì¥ DB ì‚¬ìš© ì—¬ë¶€
    # mariadb.enabled: trueì¸ ê²½ìš°, ë‚´ë¶€ DBë¥¼ ì‚¬ìš©í•˜ê³  ì™¸ë¶€ DBëŠ” ë¹„í™œì„±í™”
    mariadb:
      enabled: false 

    # ì™¸ë¶€ DB ì‚¬ìš© ì—¬ë¶€ (SCDF ì„œë²„ì˜ ë©”íƒ€ë°ì´í„° ì €ì¥ìš©)
    externalDatabase:    
      host: mariadb.default.svc.cluster.local   # DNS ì´ë¦„:<service-name>.<namespace>.svc.cluster.local
      port: 3306
      user: neodain
      password: Kht72@eye1
      database: demo
      # existingSecret: scdf-db-secret   # â† Secretë¡œ ê´€ë¦¬ ì‹œ í™œì„±í™” (keys: mariadb-password ë“± ì°¨íŠ¸ ìŠ¤í‚¤ë§ˆì— ë§ì¶°)

    # JVM/Actuator/ë³´ì•ˆ/í”„ë¡œë¸Œ ê°•í™”
    extraEnvVars:
      - name: JAVA_TOOL_OPTIONS
        value: >-
          -XX:+ExitOnOutOfMemoryError -XX:MaxRAMPercentage=75.0
          -Dserver.forward-headers-strategy=native
      - name: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
        value: "health,info,metrics,prometheus"
      - name: MANAGEMENT_METRICS_TAGS_APPLICATION
        value: "scdf-server"

    livenessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6

    readinessProbe:
      enabled: true
      initialDelaySeconds: 20
      periodSeconds: 5
      timeoutSeconds: 3
      failureThreshold: 6

    nodeSelector:
      role: control

    podSecurityContext:
      enabled: true
      runAsNonRoot: true
      fsGroup: 1001

    containerSecurityContext: 
      enabled: true
      runAsUser: 1001
      allowPrivilegeEscalation: false # ê¶Œí•œ ìƒìŠ¹ ê¸ˆì§€ (í•„ìš” ì‹œ true, ë³´ì•ˆ ê°•í™” ì‹œ false) 
      readOnlyRootFilesystem: true  # ë£¨íŠ¸ íŒŒì¼ì‹œìŠ¤í…œ ì½ê¸° ì „ìš© (/tmp ë“±, emptyDir ë§ˆìš´íŠ¸ í•„ìš” ì—¬ë¶€ ì ê²€) 

    # Prometheus ìŠ¤í¬ë© ì„¤ì •
    # SCDF ì„œë²„ì˜ Actuator ì—”ë“œí¬ì¸íŠ¸ë¥¼ Prometheusê°€ ìŠ¤í¬ë©
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/path: "/actuator/prometheus"
      prometheus.io/port: "8080"
    
    affinity:                       # (ì„ íƒì‚¬í•­) NodeAffinity / PodAffinity ë“± ì •êµí•œ ë°°ì¹˜ ì „ëµ
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
              - key: role
                operator: In
                values:
                  - control          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨
    
    tolerations:                    # Taintsê°€ ê±¸ë¦° ë…¸ë“œì—ë„ í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë°°ì¹˜ í—ˆìš©
      - key: "type"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key  
        operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
        value: "scdf"               # í•´ë‹¹ ê°’ì´ "scdf"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
        effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨


  skipper:
    enabled: true 

    replicaCount: 1            # Skipper ì„œë²„ëŠ” ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤ë¡œ ìš´ì˜
    # SkipperëŠ” SCDFì˜ ë°°í¬/ë°°ì¹˜ ê´€ë¦¬ ì„œë²„ ì—­í• 
    # SkipperëŠ” SCDF ì„œë²„ì™€ ë³„ë„ë¡œ ìš´ì˜ë˜ë©°, ë°°í¬/ë°°ì¹˜ ì‘ì—…ì„ ì²˜ë¦¬í•œë‹¤.

    image:
      repository: bitnami/spring-cloud-skipper
      tag: "2.11.5"
      pullPolicy: IfNotPresent

    service:
      type: NodePort
      port: 8080
      nodePort: 32081

    resources:
      requests: { cpu: 250m, memory: 512Mi }
      limits:   { cpu: 500m, memory: 1024Mi } 

    # Skipperë„ ì™¸ë¶€ DB ë¶„ë¦¬ ê¶Œì¥
    externalDatabase:
      host: mariadb.default.svc.cluster.local
      port: 3306
      user: neodain 
      password: Kht72@eye1 
      database: skipper_meta
      # existingSecret: skipper-db-secret

    extraEnvVars:
      - name: JAVA_TOOL_OPTIONS
        value: >-
          -XX:+ExitOnOutOfMemoryError -XX:MaxRAMPercentage=75.0
      - name: MANAGEMENT_ENDPOINTS_WEB_EXPOSURE_INCLUDE
        value: "health,info,metrics,prometheus"
      - name: MANAGEMENT_METRICS_TAGS_APPLICATION
        value: "skipper"

    livenessProbe:
      enabled: true
      initialDelaySeconds: 30
      periodSeconds: 10

    readinessProbe:
      enabled: true
      initialDelaySeconds: 20
      periodSeconds: 5

    nodeSelector:
      role: control

    podSecurityContext:
      enabled: true
      runAsNonRoot: true
      fsGroup: "1001"

    containerSecurityContext:
      enabled: true
      runAsUser: "1001"
      allowPrivilegeEscalation: false # ê¶Œí•œ ìƒìŠ¹ í—ˆìš© (í•„ìš” ì‹œ true, ë³´ì•ˆ ê°•í™” ì‹œ false) : scdfëŠ” trueë¡œ ì„¤ì •
      readOnlyRootFilesystem: true   # ë£¨íŠ¸ íŒŒì¼ì‹œìŠ¤í…œ ì½ê¸° ì „ìš© (/tmp ë“±, emptyDir ë§ˆìš´íŠ¸ í•„ìš” ì—¬ë¶€ ì ê²€)

    # Prometheus ìŠ¤í¬ë© ì„¤ì •
    # Skipperì˜ Actuator ì—”ë“œí¬ì¸íŠ¸ë¥¼ Prometheusê°€ ìŠ¤í¬ë©
    podAnnotations:
      prometheus.io/scrape: "true"
      prometheus.io/path: "/actuator/prometheus"
      prometheus.io/port: "8080"

    affinity:                       # (ì„ íƒì‚¬í•­) NodeAffinity / PodAffinity ë“± ì •êµí•œ ë°°ì¹˜ ì „ëµ
      nodeAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
          nodeSelectorTerms:
            - matchExpressions:
              - key: role
                operator: In
                values:
                  - control          # ì´ ì¡°ê±´ì€ nodeSelectorì™€ ë™ì¼í•œ íš¨ê³¼ì§€ë§Œ ë” ìœ ì—°í•¨

    tolerations:                    # Taintsê°€ ê±¸ë¦° ë…¸ë“œì—ë„ í•´ë‹¹ ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ ë°°ì¹˜ í—ˆìš©
      - key: "type"                 # ë…¸ë“œì— taintë¡œ ì„¤ì •ëœ key
        operator: "Equal"           # ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ê°’ì¼ ë•Œë§Œ í—ˆìš©
        value: "skipper"            # í•´ë‹¹ ê°’ì´ "skipper"ì¼ ê²½ìš°ë§Œ ì´ PodëŠ” ìŠ¤ì¼€ì¤„ë§ í—ˆìš©ë¨
        effect: "NoSchedule"        # taintê°€ NoSchedule ì¼ ë•Œ ì´ tolerationì´ ì—†ìœ¼ë©´ ë°°ì¹˜ ì•ˆ ë¨

  # --- SCDF ê¸°ëŠ¥ í”Œë˜ê·¸ ---
  features:
    streaming:
      enabled: false
    rabbitmq:
      enabled: false


# Spring Cloud Data Flow Task í”Œë«í¼ ì„¤ì • 
# Kubernetesì—ì„œ Task ì•±ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ê³„ì • ì„¤ì • 
# ì´ ì„¤ì •ì€ SCDF ì„œë²„ì˜ Task í”Œë«í¼ ê³„ì • ê´€ë¦¬ì—ì„œ ì‚¬ìš©ë¨
# ì‚¬ìš©ë²• (ì‹¤í–‰ì‹œì ):
# SCDF UI: Task ì‹¤í–‰/ìŠ¤ì¼€ì¤„ ë§Œë“¤ ë•Œ â€œPlatformâ€ ë“œë¡­ë‹¤ìš´ì—ì„œ ê³„ì • ì„ íƒ
# SCDF Shell/HTTP: platformName ì§€ì • (ê³„ì • ì´ë¦„ìœ¼ë¡œ ì‹¤í–‰)
# ì˜ˆ) Shell : task launch my-task --platformName default --name my-task-instance  # default ê³„ì •ìœ¼ë¡œ ì‹¤í–‰
# task launch --name batch-task-01 --platformName work-2 # work-2 ê³„ì •ìœ¼ë¡œ ì‹¤í–‰
# 
# ì‘ì—… ì „ìš© ë…¸ë“œ(work-2)ë¡œ ë³´ë‚´ê³  ì‹¶ìœ¼ë©´, í•´ë‹¹ ë…¸ë“œì— labelê³¼ taint ì„¤ì • í•„ìš”
# ì‘ì—… ì „ìš© ë…¸ë“œ(work-2) ì„¤ì • ì˜ˆì‹œ:
# kubectl label node work-2 role=work-2
# kubectl taint node work-2 type=task:NoSchedule
# kubectl get nodes --show-labels

# SCDFì—ì„œ TASK ì‹¤í–‰
# ìƒì„±ëœ Task ì•±ì„ ì‹¤í–‰í•˜ë ¤ë©´ SCDF UI ë˜ëŠ” Shellì„ ì‚¬ìš©í•˜ì—¬ ì‹¤í–‰í•  ìˆ˜ ìˆë‹¤.
# ì˜ˆì‹œ:
# scdf:> task launch --name batch-task-01 --platformName default
# scdf:> task launch --name batch-task-01 --platformName work-2
# scdf:> task launch --name batch-task-01 --platformName default --arguments "--runDate=2025-07-10" 
# scdf:> task launch --name batch-task-01 --platformName work-2 --arguments "--runDate=2025-07-10"
# scdf:> task schedule create --name my-schedule --definition "batch-task-01 --platformName default" --crontab "0 0 * * *" --platformName default
# ìƒì„±ëœ Job/CronJobì€ Kubernetesì—ì„œ ê´€ë¦¬ë˜ë©°, SCDF UI ë˜ëŠ” Shellì—ì„œ ìƒíƒœë¥¼ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆë‹¤.
# ìƒì„±ëœ Job/Task ì´ë¦„ í™•ì¸ ë°©ë²•:
# kubectl get jobs --namespace scdf-server  
# kubectl get cronjobs --namespace scdf-server
# kubectl get pods --namespace scdf-server
# kubectl get tasks --namespace scdf-server
# kubectl get jobs -n scdf-server -o wide
# kubectl get jobs -n default -o wide
# kubectl get jobs -n work-2 -o wide
# Job ìŠ¤í™ í™•ì¸ ë°©ë²•:
# kubectl describe job batch-job-01 --namespace scdf-server 
# kubectl describe cronjob batch-job-02 --namespace scdf-server
# kubectl get job batch-job-01 --namespace scdf-server -o yaml
# kubectl get cronjob batch-job-02 --namespace scdf-server -o yaml
# kubectl get job batch-job-01 -n default -o yaml


# =========================
# SCDF Task Platform (ConfigMap: application.yaml ë¡œ ì£¼ì…ë¨)
# =========================
config:
  spring:
    cloud:
      dataflow:
        task:
          platform:
            kubernetes:
              accounts:

                # ê¸°ë³¸ ê³„ì •: ê°œë°œ/ê³µìš©
                default:
                  namespace: default
                  imagePullPolicy: IfNotPresent
                  entryPointStyle: shell
                  requests:
                    cpu: 200m
                    memory: 512Mi
                  limits:
                    cpu: "1"
                    memory: 1024Mi
                  backoffLimit: 1
                  ttlSecondsAfterFinished: 7200
                  environmentVariables: "SPRING_PROFILES_ACTIVE=dev"
                  podAnnotations:
                    prometheus.io/scrape: "true"
                    prometheus.io/path: "/actuator/prometheus"
                    prometheus.io/port: "8080"

                # ì‘ì—… ì „ìš© ë…¸ë“œë¡œ ë³´ë‚´ê³  ì‹¶ì€ ê³„ì •(ì˜ˆ: work-2)
                work-2:
                  namespace: default
                  imagePullPolicy: IfNotPresent
                  entryPointStyle: shell
                  requests:
                    cpu: 500m
                    memory: 1024Mi
                  limits:
                    cpu: "2"
                    memory: 2048Mi
                  nodeSelector:
                    role: work-2
                  tolerations:
                    - key: "type"
                      operator: "Equal"
                      value: "task"
                      effect: "NoSchedule"
                  backoffLimit: 1
                  ttlSecondsAfterFinished: 7200
                  environmentVariables: "SPRING_PROFILES_ACTIVE=dev"
                  podAnnotations:
                    prometheus.io/scrape: "true"
                    prometheus.io/path: "/actuator/prometheus"
                    prometheus.io/port: "8080"
