{{- /* charts/batch-task/templates/configmap-env.yaml */ -}}
{{- $root := . -}}
{{- range .Values.batchTasks.tasks }}
{{- $res := include "batch-task.resname" (dict "root" $root "name" .name) -}}
{{- $hasDS  := hasKey . "datasource" -}}
{{- $hasDSS := and (hasKey . "datasource_sub") .datasource_sub -}}
{{- $hasIFX := hasKey . "influx" -}}
{{- if or $hasDS $hasDSS $hasIFX }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $res }}-env
  labels:
    {{- include "batch-task.labels" $root | nindent 4 }}
data:
  {{- if $hasDS }}
  SPRING_DATASOURCE_DRIVER_CLASS_NAME: "{{ .datasource.driver_class_name }}"
  SPRING_DATASOURCE_URL: "{{ .datasource.url }}"
  SPRING_DATASOURCE_USERNAME: "{{ .datasource.username }}"
  {{- end }}
  {{- if and $hasDSS .datasource_sub.enabled }}
  APP_DATASOURCE_SUB_DRIVER_CLASS_NAME: "{{ .datasource_sub.driver_class_name }}"
  APP_DATASOURCE_SUB_URL: "{{ .datasource_sub.url }}"
  APP_DATASOURCE_SUB_USERNAME: "{{ .datasource_sub.username }}"
  {{- end }}
  {{- if $hasIFX }}
  APP_INFLUX_URL: "{{ .influx.url }}"
  APP_INFLUX_LOG_LEVEL: "{{ .influx.logLevel }}"
  APP_INFLUX_READ_TIMEOUT: "{{ .influx.readTimeout }}"
  APP_INFLUX_WRITE_TIMEOUT: "{{ .influx.writeTimeout }}"
  APP_INFLUX_CONNECT_TIMEOUT: "{{ .influx.connectTimeout }}"
  {{- end }}
---
{{- end }}
{{- end }}